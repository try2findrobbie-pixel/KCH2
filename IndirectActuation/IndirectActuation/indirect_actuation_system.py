# Fusion 360 script: Indirect Actuation System
# Save this file and run it inside Fusion 360's "Scripts and Add-Ins" dialog.
#
# Notes:
# - This script creates a new component and sketches/extrudes simple geometry.
# - It's based on the code you provided but wrapped with runtime checks and minor fixes
#   to be more robust when executed inside Fusion 360.
#
# Author: Generated by GitHub Copilot (assistant)
# Date: 2025-12-18

import adsk.core, adsk.fusion, adsk.cam, traceback

def run(context):
    ui = None
    try:
        app = adsk.core.Application.get()
        ui = app.userInterface

        # Ensure an active Fusion design is present
        design = adsk.fusion.Design.cast(app.activeProduct)
        if not design:
            ui.messageBox('No active Fusion design. Please open or create a design and try again.')
            return

        # Create a new occurrence + component for the model
        root = design.rootComponent
        occ = root.occurrences.addNewComponent(adsk.core.Matrix3D.create())
        comp = occ.component
        comp.name = 'Indirect Actuation System'

        sketches = comp.sketches
        extrudes = comp.features.extrudeFeatures

        # Use component XY plane for 2D sketches
        xyPlane = comp.xYConstructionPlane

        # Helper to safely get a profile from a sketch (default to first profile)
        def _first_profile(sketch):
            if sketch.profiles.count == 0:
                raise ValueError('Sketch has no profiles')
            return sketch.profiles.item(0)

        # 1. Piston Assembly (Front-mounted, behind mag well)
        pistonSketch = sketches.add(xyPlane)
        lines = pistonSketch.sketchCurves.sketchLines

        # Piston body rectangle (width 12.7 mm = 1.27 cm, height 9.525 mm = 0.9525 cm)
        # Positioned approx at X = 9.093 cm (90.93 mm from datum)
        p1 = adsk.core.Point3D.create(9.093 - 0.635, -2.286 - 0.47625, 0)
        p2 = adsk.core.Point3D.create(9.093 + 0.635, -2.286 - 0.47625, 0)
        p3 = adsk.core.Point3D.create(9.093 + 0.635, -2.286 + 0.47625, 0)
        p4 = adsk.core.Point3D.create(9.093 - 0.635, -2.286 + 0.47625, 0)
        lines.addByTwoPoints(p1, p2)
        lines.addByTwoPoints(p2, p3)
        lines.addByTwoPoints(p3, p4)
        lines.addByTwoPoints(p4, p1)

        # Simple spring coils (circles)
        circles = pistonSketch.sketchCurves.sketchCircles
        circles.addByCenterRadius(adsk.core.Point3D.create(9.5, -2.032, 0), 0.2)
        circles.addByCenterRadius(adsk.core.Point3D.create(9.8, -2.032, 0), 0.2)

        # Extrude piston body (thickness 9.525 mm = 0.9525 cm)
        pistonProf = _first_profile(pistonSketch)
        pistonExt = extrudes.addSimple(pistonProf, adsk.core.ValueInput.createByString('0.9525 cm'), adsk.fusion.FeatureOperations.NewBodyFeatureOperation)
        pistonExt.bodies.item(0).name = 'Piston Body'

        # Mounting bracket (simple L-shape)
        bracketSketch = sketches.add(xyPlane)
        bLines = bracketSketch.sketchCurves.sketchLines
        bLines.addByTwoPoints(adsk.core.Point3D.create(9.093, -2.54, 0), adsk.core.Point3D.create(9.093, -3.0, 0))
        bLines.addByTwoPoints(adsk.core.Point3D.create(9.093, -2.54, 0), adsk.core.Point3D.create(9.5, -2.54, 0))
        bracketProf = _first_profile(bracketSketch)
        bracketExt = extrudes.addSimple(bracketProf, adsk.core.ValueInput.createByString('0.5 cm'), adsk.fusion.FeatureOperations.NewBodyFeatureOperation)
        bracketExt.bodies.item(0).name = 'Mounting Bracket'

        # 2. Cam (centered at trigger pin approx 112.95 mm = 11.295 cm)
        camSketch = sketches.add(xyPlane)
        camCircles = camSketch.sketchCurves.sketchCircles
        camCenter = adsk.core.Point3D.create(11.295, -1.27, 0)
        camCircles.addByCenterRadius(camCenter, 0.762)  # radius 7.62 mm
        # Approximate lobe (secondary circle to hint lobe geometry)
        camCircles.addByCenterRadius(adsk.core.Point3D.create(11.295 + 0.254, -1.27, 0), 0.762)

        # Actuation arm line
        armLines = camSketch.sketchCurves.sketchLines
        armLines.addByTwoPoints(camCenter, adsk.core.Point3D.create(11.295 + 1.016, -1.27 - 0.5, 0))

        camProf = _first_profile(camSketch)
        camExt = extrudes.addSimple(camProf, adsk.core.ValueInput.createByString('0.762 cm'), adsk.fusion.FeatureOperations.NewBodyFeatureOperation)
        camExt.bodies.item(0).name = 'Cam'

        # 3. Sled
        sledSketch = sketches.add(xyPlane)
        sLines = sledSketch.sketchCurves.sketchLines
        # Rectangle 25.4 mm wide x 3.81 mm high
        s1 = adsk.core.Point3D.create(10.16, -3.048, 0)
        s2 = adsk.core.Point3D.create(12.7, -3.048, 0)
        s3 = adsk.core.Point3D.create(12.7, -2.667, 0)
        s4 = adsk.core.Point3D.create(10.16, -2.667, 0)
        sLines.addByTwoPoints(s1, s2)
        sLines.addByTwoPoints(s2, s3)
        sLines.addByTwoPoints(s3, s4)
        sLines.addByTwoPoints(s4, s1)

        sledProf = _first_profile(sledSketch)
        sledExt = extrudes.addSimple(sledProf, adsk.core.ValueInput.createByString('1.0 cm'), adsk.fusion.FeatureOperations.NewBodyFeatureOperation)
        sledExt.bodies.item(0).name = 'Sled'

        # 4. Lever (at selector approx 141.53 mm = 14.153 cm)
        leverSketch = sketches.add(xyPlane)
        lLines = leverSketch.sketchCurves.sketchLines
        lLines.addByTwoPoints(adsk.core.Point3D.create(14.153, 0, 0), adsk.core.Point3D.create(14.153, -2.032, 0))
        lLines.addByTwoPoints(adsk.core.Point3D.create(14.153, -2.032, 0), adsk.core.Point3D.create(14.5, -2.5, 0))

        leverProf = _first_profile(leverSketch)
        leverExt = extrudes.addSimple(leverProf, adsk.core.ValueInput.createByString('0.381 cm'), adsk.fusion.FeatureOperations.NewBodyFeatureOperation)
        leverExt.bodies.item(0).name = 'Lever'

        ui.messageBox('Indirect actuation system modeled successfully in new component!', 'Done')

    except Exception:
        if ui:
            ui.messageBox('Failed:\n{}'.format(traceback.format_exc()), 'Script Error')
        else:
            print('Failed:\n{}'.format(traceback.format_exc()))

def stop(context):
    # Optional cleanup - Fusion will close the script after run, but stop is provided by many scripts.
    adsk.terminate()
